# encoding: utf-8
# author: Sean Carolan
# author: Adam Leff
# author: Matt Ray
# inspired by https://community.spiceworks.com/topic/1994651-check-for-missing-wannacry-patches-with-powershell

control 'WannaCry Vulnerability Check' do
  impact 1.0
  title 'Hot-fix mitigation check for WannaCry Ransomware vulnerability'
  desc '
   Checks Windows systems for hotfixes that patch against the WannaCry exploit.
   If this test fails, you should run Windows update ASAP.
  '

  # List of known Knowledgebase IDs that include hotfixes for WannaCry
  # Do you have additional? Please submit a PR!
  # https://support.microsoft.com/en-us/help/4023262/how-to-verify-that-ms17-010-is-installed
  # Windows XP:                       KB4012598
  # Windows Vista SP2:                KB4012598
  # Windows 8:                        KB4012598
  # Windows Server 2003 SP2:          KB4012598
  # Windows Server 2008 R2 SP2:       KB4012598
  # Windows Server 2008 R2 SP1/7 SP1: KB4012212 KB4012215 KB4012218 KB4015546 KB4015549
  #                                   KB4015552 KB4019263 KB4019264 KB4019265 KB4022722
  #                                   KB4022168 KB4012218 KB4015552 KB4019265 KB4022168
  # Windows Server 2012:              KB4012214 KB4012217 KB4012220 KB4015551 KB4015554
  #                                   KB4019214 KB4019216 KB4019218 KB4022718 KB4022724
  #                                   KB4012220 KB4015554 KB4019218 KB4022721
  # Windows Server 2012 R2/8.1:       KB4012213 KB4012216 KB4015550 KB4015553 KB4019213
  #                                   KB4019215 KB4019217 KB4022717 KB4022720 KB4012219
  #                                   KB4015553 KB4019217 KB4022720
  # Windows 10:                       KB4012606 KB4016637 KB4015221 KB4019474 KB4013198
  #                                   KB4016636 KB4015219 KB4019473 KB4032695 KB4032693
  # Windows Server 2016:              KB4013429 KB4016635 KB4015217 KB4019472 KB4022723

  hotfixes = %w{ KB4032695 KB4032693 KB4022724 KB4022723 KB4022722 KB4022721 KB4022720 KB4022718 KB4022717 KB4022168 KB4019474 KB4019473 KB4019472 KB4019265 KB4019265 KB4019264 KB4019263 KB4019218 KB4019217 KB4019216 KB4019215 KB4019214 KB4019213 KB4016637 KB4016636 KB4016635 KB4015554 KB4015553 KB4015552 KB4015551 KB4015550 KB4015549 KB4015546 KB4015221 KB4015219 KB4015217 KB4013429 KB4013198 KB4012606 KB4012598 KB4012220 KB4012219 KB4012218 KB4012217 KB4012216 KB4012215 KB4012214 KB4012213 KB4012212 }

  describe.one do
    hotfixes.each do |hotfix|
      describe windows_hotfix(hotfix) do
        it { should be_installed }
      end
    end
  end
end
