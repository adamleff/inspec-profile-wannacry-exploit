# encoding: utf-8
# author: Sean Carolan
# author: Adam Leff
# inspired by https://community.spiceworks.com/topic/1994651-check-for-missing-wannacry-patches-with-powershell

control 'WannaCry Vulnerability Check' do
  impact 1.0
  title 'Hot-fix mitigation check for WannaCry Ransomware vulnerability'
  desc '
   Checks Windows systems for hotfixes that patch against the WannaCry exploit.
   If this test fails, you should run Windows update ASAP.
  '

  # List of known Knowledgebase IDs that include hotfixes for WannaCry
  # Do you have additional? Please submit a PR!
  # Windows Server 2008:    KB4018466
  # Windows Server 2008 R2: KB4012212 KB4012215 KB4015549 KB4019264
  # Windows Server 2012:    KB4012214 KB4012217 KB4015551 KB4019216
  # Windows Server 2012 R2: KB4012213 KB4012216 KB4015550 KB4019215 KB4012219 KB4015553 KB4015554
  # Windows Server 2016:    KB4013429 KB4019472 KB4015217 KB4015438 KB4016635 KB4016871

  hotfixes = %w{ KB4012212 KB4012213 KB4012214 KB4012215 KB4012216 KB4012217 KB4012219 KB4013429 KB4015217 KB4015438 KB4015549 KB4015550 KB4015551 KB4015553 KB4015554 KB4016635 KB4016871 KB4018466 KB4019215 KB4019216 KB4019264 KB4019472 }

  describe.one do
    hotfixes.each do |hotfix|
      filter = "HotFixID = '" + hotfix + "'"
      describe wmi({
        class: 'win32_quickfixengineering',
        filter: filter,
      }) do
        its( 'InstalledOn' ) { should_not eq nil }
      end
    end
  end
end
